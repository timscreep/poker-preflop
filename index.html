<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>GTO Trainer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --base: #0b0e14; --surf: #161b22; --text: #c9d1d9; --accent: #58a6ff; }
        body { background: var(--base); color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; }
        
        /* Стол */
        .poker-table { width: 300px; height: 160px; border: 4px solid #30363d; border-radius: 100px; position: relative; margin: 20px 0; background: radial-gradient(#1f242c, #0b0e14); }
        .pos-node { position: absolute; width: 36px; height: 36px; border-radius: 50%; background: #21262d; border: 2px solid #30363d; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; transition: 0.3s; }
        .pos-hero { border-color: #d29922; color: #d29922; box-shadow: 0 0 10px rgba(210,153,34,0.3); }
        .pos-villain { border-color: #f85149; color: #f85149; }

        /* Матрица */
        .matrix { display: grid; grid-template-columns: repeat(13, 1fr); gap: 1px; background: #30363d; border: 1px solid #30363d; }
        .cell { width: 36px; height: 36px; background: #89b4fa; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; position: relative; }
        .cell-fill { position: absolute; bottom: 0; left: 0; width: 100%; z-index: 1; }
        .cell-text { position: relative; z-index: 2; color: #000; font-weight: 600; }

        /* Карты */
        .card { width: 80px; height: 110px; border-radius: 8px; display: flex; flex-direction: column; padding: 10px; font-weight: bold; color: white; }
        .s { background: #21262d; } .h { background: #da3633; } .c { background: #238636; } .d { background: #1f6feb; }
        .card .val { font-size: 24px; } .card .suit { font-size: 32px; align-self: flex-end; margin-top: auto; }

        .active-tab { color: #58a6ff; border-bottom: 2px solid #58a6ff; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="p-4">

    <div class="flex gap-8 mb-6 font-bold uppercase text-xs tracking-widest">
        <button onclick="setTab('ed')" id="tab-ed" class="active-tab pb-1">Редактор</button>
        <button onclick="setTab('tr')" id="tab-tr" class="opacity-50 pb-1">Тренажер</button>
    </div>

    <div class="bg-[#161b22] p-3 rounded-lg flex gap-4 mb-6 border border-[#30363d]">
        <select id="mode" onchange="syncUI()" class="bg-[#0d1117] p-1 rounded text-sm outline-none">
            <option value="RFI">RFI</option>
            <option value="vsOpen">vs Open</option>
            <option value="vs3bet">vs 3-Bet</option>
        </select>
        <select id="hero" onchange="syncUI()" class="bg-[#0d1117] p-1 rounded text-sm outline-none">
            <option>UTG</option><option>MP</option><option>CO</option><option>BTN</option><option>SB</option><option>BB</option>
        </select>
        <button onclick="loadRemote()" class="text-xs bg-blue-600/20 text-blue-400 px-3 py-1 rounded border border-blue-600/30">Загрузить JSON</button>
    </div>

    <div id="view-ed" class="flex flex-col items-center">
        <div class="flex gap-4 items-center mb-4 bg-[#161b22] p-3 rounded-lg w-full justify-center">
            <button class="dot w-8 h-8 rounded bg-[#f38ba8]" data-a="raise"></button>
            <button class="dot w-8 h-8 rounded bg-[#a6e3a1]" data-a="call"></button>
            <button class="dot w-8 h-8 rounded bg-[#f9e2af]" data-a="check"></button>
            <input type="range" id="freq" min="0" max="100" step="10" value="100" class="w-24">
            <span id="freq-txt" class="text-xs font-mono w-8">100%</span>
        </div>
        <div id="matrix" class="matrix"></div>
        <button onclick="exportJSON()" class="mt-4 text-[10px] opacity-30 hover:opacity-100 uppercase">Экспорт в файл</button>
    </div>

    <div id="view-tr" class="hidden flex flex-col items-center w-full max-w-sm">
        <div class="poker-table" id="table-visual">
            <div class="pos-node" style="top: -18px; left: 132px;" data-p="UTG">UTG</div>
            <div class="pos-node" style="top: 20px; right: -18px;" data-p="MP">MP</div>
            <div class="pos-node" style="bottom: 20px; right: -18px;" data-p="CO">CO</div>
            <div class="pos-node" style="bottom: -18px; left: 132px;" data-p="BTN">BTN</div>
            <div class="pos-node" style="bottom: 20px; left: -18px;" data-p="SB">SB</div>
            <div class="pos-node" style="top: 20px; left: -18px;" data-p="BB">BB</div>
        </div>

        <div id="cards-spot" class="flex gap-4 mb-8 h-[110px]"></div>
        
        <div id="feedback" class="h-12 text-center mb-4 text-sm font-bold"></div>

        <div class="grid grid-cols-2 gap-3 w-full">
            <button onclick="handleAct('raise')" class="p-3 rounded bg-red-500/10 border border-red-500/30 hover:bg-red-500 hover:text-white transition">RAISE</button>
            <button onclick="handleAct('call')" class="p-3 rounded bg-green-500/10 border border-green-500/30 hover:bg-green-500 hover:text-white transition">CALL</button>
            <button onclick="handleAct('check')" class="p-3 rounded bg-yellow-500/10 border border-yellow-500/30 hover:bg-yellow-500 hover:text-black transition">CHECK</button>
            <button onclick="handleAct('fold')" class="p-3 rounded bg-blue-500/10 border border-blue-500/30 hover:bg-blue-500 hover:text-white transition">FOLD</button>
        </div>
        <button id="next-btn" onclick="deal()" class="mt-6 py-2 px-8 bg-white text-black rounded font-bold hidden">NEXT</button>
    </div>

<script>
    const RANKS = "AKQJT98765432".split("");
    const POSITIONS = ["UTG", "MP", "CO", "BTN", "SB", "BB"];
    const COLORS = { raise:'#f38ba8', call:'#a6e3a1', check:'#f9e2af', fold:'#89b4fa' };
    
    let rangeData = {}; 
    let selAction = 'raise';
    let isDrawing = false;
    let currentHand = null;

    function syncUI() {
        const m = document.getElementById('mode').value;
        const h = document.getElementById('hero');
        // Логика ограничений
        if (m === 'RFI' && h.value === 'BB') h.value = 'SB';
        const bbOpt = h.querySelector('option[value="BB"]');
        if (m === 'RFI') h.options[5].disabled = true; else h.options[5].disabled = false;
    }

    function init() {
        const mx = document.getElementById('matrix');
        RANKS.forEach((r1, i) => {
            RANKS.forEach((r2, j) => {
                const combo = i < j ? r1+r2+'s' : (i > j ? r2+r1+'o' : r1+r2);
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.hand = combo;
                cell.innerHTML = `<div class="cell-fill" style="height:100%; background:${COLORS.fold}"></div><div class="cell-text">${combo}</div>`;
                cell.onmousedown = (e) => { e.preventDefault(); isDrawing=true; paint(cell); };
                cell.onmouseover = () => { if(isDrawing) paint(cell); };
                mx.appendChild(cell);
            });
        });
        window.onmouseup = () => isDrawing = false;
        document.querySelectorAll('.dot').forEach(d => d.onclick = () => {
            selAction = d.dataset.a;
            document.querySelectorAll('.dot').forEach(x=>x.style.boxShadow='none');
            d.style.boxShadow = '0 0 0 2px white';
        });
        document.querySelector('[data-a="raise"]').click();
        document.getElementById('freq').oninput = (e) => document.getElementById('freq-txt').innerText = e.target.value + '%';
    }

    function paint(cell) {
        const h = cell.dataset.hand;
        const f = parseInt(document.getElementById('freq').value);
        if (f === 0) delete rangeData[h];
        else rangeData[h] = { a: selAction, f: f };
        renderMatrix();
    }

    function renderMatrix() {
        document.querySelectorAll('.cell').forEach(c => {
            const data = rangeData[c.dataset.hand];
            const fill = c.querySelector('.cell-fill');
            if (data) {
                fill.style.height = '100%';
                fill.style.background = `linear-gradient(to top, ${COLORS[data.a]} ${data.f}%, ${COLORS.fold} ${data.f}%)`;
            } else {
                fill.style.background = COLORS.fold;
            }
        });
    }

    function setTab(t) {
        document.getElementById('view-ed').classList.toggle('hidden', t!=='ed');
        document.getElementById('view-tr').classList.toggle('hidden', t!=='tr');
        document.getElementById('tab-ed').className = t==='ed' ? 'active-tab pb-1' : 'opacity-50 pb-1';
        document.getElementById('tab-tr').className = t==='tr' ? 'active-tab pb-1' : 'opacity-50 pb-1';
        if(t==='tr') deal();
    }

    function deal() {
        const mode = document.getElementById('mode').value;
        const heroPos = document.getElementById('hero').value;
        document.getElementById('feedback').innerText = "";
        document.getElementById('next-btn').classList.add('hidden');

        // Визуализация стола
        document.querySelectorAll('.pos-node').forEach(n => {
            n.className = 'pos-node';
            if (n.dataset.p === heroPos) n.classList.add('pos-hero');
        });

        let villainPos = null;
        if (mode === 'vsOpen' || mode === 'vs3bet') {
            const hIdx = POSITIONS.indexOf(heroPos);
            // Виллаин - это кто-то до Hero (vsOpen) или после (vs3bet)
            if (mode === 'vsOpen') {
                if (hIdx === 0) { alert("UTG не может играть vs Open. Переключаю на MP"); document.getElementById('hero').value="MP"; return deal(); }
                villainPos = POSITIONS[Math.floor(Math.random() * hIdx)];
            } else {
                villainPos = POSITIONS[hIdx + 1 + Math.floor(Math.random() * (5 - hIdx))];
                if (!villainPos) villainPos = 'BTN';
            }
            document.querySelector(`[data-p="${villainPos}"]`).classList.add('pos-villain');
        }

        // Генерация карт
        const r1 = RANKS[Math.floor(Math.random()*13)], r2 = RANKS[Math.floor(Math.random()*13)];
        const s1 = ["s","h","c","d"][Math.floor(Math.random()*4)], s2 = ["s","h","c","d"][Math.floor(Math.random()*4)];
        if (r1===r2 && s1===s2) return deal();
        
        // Сортировка для ключа
        const i1 = RANKS.indexOf(r1), i2 = RANKS.indexOf(r2);
        currentHand = { r1, r2, s1, s2, combo: i1 < i2 ? r1+r2+(s1===s2?'s':'o') : (i1 > i2 ? r2+r1+(s1===s2?'s':'o') : r1+r2) };
        if (i1 > i2) { // Для визуализации ставим старшую слева
            currentHand.r1 = r2; currentHand.r2 = r1; currentHand.s1 = s2; currentHand.s2 = s1;
        }

        const suits = {s:'♠', h:'♥', c:'♣', d:'♦'};
        const classes = {s:'s', h:'h', c:'c', d:'d'};
        document.getElementById('cards-spot').innerHTML = `
            <div class="card ${classes[currentHand.s1]}"><div class="val">${currentHand.r1}</div><div class="suit">${suits[currentHand.s1]}</div></div>
            <div class="card ${classes[currentHand.s2]}"><div class="val">${currentHand.r2}</div><div class="suit">${suits[currentHand.s2]}</div></div>
        `;
    }

    function handleAct(uA) {
        if (!document.getElementById('next-btn').classList.contains('hidden')) return;
        const data = rangeData[currentHand.combo] || { a: 'fold', f: 100 };
        const fb = document.getElementById('feedback');
        
        // Верно если: нажато основное действие ИЛИ (действие смешанное и нажато fold)
        const isCorrect = (uA === data.a) || (data.f < 100 && uA === 'fold');

        if (isCorrect) {
            fb.innerHTML = `<span class="text-green-400">ВЕРНО</span><br><span class="opacity-50">${data.a} ${data.f}% / fold ${100-data.f}%</span>`;
            setTimeout(deal, 1000);
        } else {
            fb.innerHTML = `<span class="text-red-400">ОШИБКА</span><br><span>Правильно: ${data.a} ${data.f}%</span>`;
            document.getElementById('next-btn').classList.remove('hidden');
        }
    }

    async function loadRemote() {
        const m = document.getElementById('mode').value;
        const h = document.getElementById('hero').value;
        try {
            const r = await fetch(`charts/${m}_${h}.json`);
            rangeData = await r.json();
            renderMatrix();
        } catch(e) { alert("Файл charts/"+m+"_"+h+".json не найден"); }
    }

    function exportJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(rangeData, null, 2));
        const a = document.createElement('a');
        a.setAttribute("href", dataStr);
        a.setAttribute("download", `${document.getElementById('mode').value}_${document.getElementById('hero').value}.json`);
        a.click();
    }

    init();
</script>
</body>
</html>
