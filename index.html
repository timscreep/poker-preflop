<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Hand Chart Pro Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --base: #1e1e2e;
            --surf0: #313244;
            --surf1: #45475a;
            --text: #cdd6f4;
            --mauve: #cba6f7;
            --r-clr: #f38ba8;
            --c-clr: #a6e3a1;
            --f-clr: #585b70;
        }
        body { background: var(--base); color: var(--text); font-family: Inter, sans-serif; }
        
        /* Стили матрицы из оригинала */
        .matrix { 
            display: grid; grid-template-columns: repeat(13, 1fr); gap: 6px; 
            background: var(--surf0); padding: 10px; border-radius: 12px; 
            max-width: 800px; width: 100%;
        }
        .cell { 
            aspect-ratio: 1; background: var(--surf1); display: flex; 
            align-items: center; justify-content: center; border-radius: 8px; 
            cursor: pointer; user-select: none; font-size: clamp(10px, 1.5vw, 14px);
            position: relative; overflow: hidden; font-weight: 600;
        }
        .cell-fill { position: absolute; inset: 0; display: flex; flex-direction: column; pointer-events: none; }
        .cell-text { position: relative; z-index: 2; }

        /* Умный слайдер */
        .slider-container { width: 100%; max-width: 800px; margin: 20px 0; }
        .track { 
            height: 40px; background: var(--f-clr); border-radius: 10px; 
            position: relative; cursor: pointer; overflow: hidden; border: 2px solid var(--surf0);
        }
        .bar-r { position: absolute; height: 100%; background: var(--r-clr); transition: width 0.1s; }
        .bar-c { position: absolute; height: 100%; background: var(--c-clr); transition: all 0.1s; }
        .handle { position: absolute; width: 2px; height: 100%; background: white; opacity: 0.5; z-index: 5; }

        .btn { @apply px-4 py-2 rounded-lg font-bold transition-all active:scale-95; }
        .btn-primary { background: var(--mauve); color: #1e1e2e; }
        .btn-secondary { background: var(--surf1); color: var(--text); }
        
        /* Тренажер */
        .card { @apply w-16 h-24 rounded-lg flex flex-col p-2 font-bold text-white shadow-xl text-xl; }
        .s { background: #313244; } .h { background: #f38ba8; } .c { background: #a6e3a1; } .d { background: #89b4fa; }
    </style>
</head>
<body class="p-6 flex flex-col items-center gap-6">

    <div class="flex gap-4">
        <button onclick="switchTab('ed')" id="btn-ed" class="btn btn-primary">Редактор</button>
        <button onclick="switchTab('tr')" id="btn-tr" class="btn btn-secondary">Тренажер</button>
    </div>

    <div id="view-ed" class="w-full flex flex-col items-center gap-4">
        <div class="slider-container">
            <div class="flex justify-between text-xs font-bold mb-2 uppercase tracking-widest">
                <span class="text-red-300">Raise: <span id="v-r">100</span>%</span>
                <span class="text-green-300">Call: <span id="v-c">0</span>%</span>
                <span class="text-slate-400">Fold: <span id="v-f">0</span>%</span>
            </div>
            <div class="track" id="main-track">
                <div id="br" class="bar-r" style="width: 100%"></div>
                <div id="bc" class="bar-c" style="left: 100%; width: 0%"></div>
                <div id="h1" class="handle" style="left: 100%"></div>
                <div id="h2" class="handle" style="left: 100%"></div>
            </div>
        </div>

        <div class="matrix" id="matrix"></div>

        <div class="flex gap-3">
            <button onclick="exportJSON()" class="btn btn-primary">Экспорт JSON</button>
            <button onclick="document.getElementById('fileIn').click()" class="btn btn-secondary">Импорт</button>
            <input type="file" id="fileIn" class="hidden" onchange="importJSON(event)">
            <button onclick="clearMatrix()" class="btn btn-secondary text-red-400">Очистить</button>
        </div>
    </div>

    <div id="view-tr" class="hidden w-full max-w-md flex flex-col items-center gap-8">
        <div id="feedback" class="w-full p-4 rounded-xl text-center font-bold hidden"></div>
        
        <div id="cards" class="flex gap-4"></div>

        <div class="grid grid-cols-2 gap-4 w-full">
            <button onclick="checkAction('raise')" class="btn py-6 bg-red-500/20 border border-red-500/40 text-red-400 hover:bg-red-500 hover:text-white">RAISE</button>
            <button onclick="checkAction('call')" class="btn py-6 bg-green-500/20 border border-green-500/40 text-green-400 hover:bg-green-500 hover:text-white">CALL</button>
            <button onclick="checkAction('fold')" class="btn py-6 bg-slate-700 border border-slate-600 col-span-2">FOLD</button>
        </div>
        
        <div class="text-sm font-mono opacity-50">Score: <span id="score">0/0</span></div>
    </div>

    <script>
        const RANKS = "AKQJT98765432".split("");
        let rangeData = {};
        let fR = 100, fC = 0;
        let isPainting = false;
        let stats = { ok: 0, total: 0 };
        let currentHand = null;

        // --- ЛОГИКА СЛАЙДЕРА ---
        const track = document.getElementById('main-track');
        track.onmousedown = (e) => {
            const update = (ee) => {
                const rect = track.getBoundingClientRect();
                let p = Math.round(((ee.clientX - rect.left) / rect.width) * 100);
                p = Math.max(0, Math.min(100, p));
                
                // К какой границе ближе клик?
                const d1 = Math.abs(p - fR);
                const d2 = Math.abs(p - (fR + fC));
                
                if (d1 < d2) {
                    const total = fR + fC;
                    fR = Math.min(p, total);
                    fC = total - fR;
                } else {
                    fC = Math.max(0, p - fR);
                }
                renderSlider();
            };
            update(e);
            window.onmousemove = update;
            window.onmouseup = () => window.onmousemove = null;
        };

        function renderSlider() {
            document.getElementById('br').style.width = fR + '%';
            document.getElementById('bc').style.left = fR + '%';
            document.getElementById('bc').style.width = fC + '%';
            document.getElementById('h1').style.left = fR + '%';
            document.getElementById('h2').style.left = (fR + fC) + '%';
            document.getElementById('v-r').innerText = fR;
            document.getElementById('v-c').innerText = fC;
            document.getElementById('v-f').innerText = 100 - fR - fC;
        }

        // --- МАТРИЦА ---
        function buildMatrix() {
            const m = document.getElementById('matrix');
            m.innerHTML = '';
            RANKS.forEach((r1, i) => {
                RANKS.forEach((r2, j) => {
                    const hand = i === j ? r1+r2 : (i < j ? r1+r2+'s' : r2+r1+'o');
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.hand = hand;
                    cell.innerHTML = `<div class="cell-fill"></div><div class="cell-text">${hand}</div>`;
                    cell.onmousedown = (e) => { isPainting = true; paint(cell); };
                    cell.onmouseover = () => { if(isPainting) paint(cell); };
                    m.appendChild(cell);
                });
            });
            window.onmouseup = () => isPainting = false;
        }

        function paint(cell) {
            rangeData[cell.dataset.hand] = { r: fR, c: fC };
            const fill = cell.querySelector('.cell-fill');
            fill.style.background = `linear-gradient(to top, var(--f-clr) ${100-(fR+fC)}%, var(--c-clr) ${100-(fR+fC)}% ${100-fR}%, var(--r-clr) ${100-fR}% 100%)`;
        }

        // --- ТРЕНАЖЕР ---
        function switchTab(t) {
            document.getElementById('view-ed').classList.toggle('hidden', t === 'tr');
            document.getElementById('view-tr').classList.toggle('hidden', t === 'ed');
            document.getElementById('btn-ed').className = t === 'ed' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('btn-tr').className = t === 'tr' ? 'btn btn-primary' : 'btn btn-secondary';
            if(t === 'tr') nextHand();
        }

        function nextHand() {
            const feedback = document.getElementById('feedback');
            feedback.classList.add('hidden');
            const r1 = RANKS[Math.floor(Math.random()*13)], r2 = RANKS[Math.floor(Math.random()*13)];
            const suits = ['s','h','c','d'], s1 = suits[Math.floor(Math.random()*4)], s2 = suits[Math.floor(Math.random()*4)];
            if(r1 === r2 && s1 === s2) return nextHand();
            
            const i1 = RANKS.indexOf(r1), i2 = RANKS.indexOf(r2);
            const handKey = i1 === i2 ? r1+r2 : (i1 < i2 ? r1+r2+'s' : r2+r1+'o');
            currentHand = rangeData[handKey] || { r: 0, c: 0 };
            
            const icons = {s:'♠', h:'♥', c:'♣', d:'♦'};
            document.getElementById('cards').innerHTML = `
                <div class="card ${s1}"><span>${r1}</span><span class="mt-auto self-end">${icons[s1]}</span></div>
                <div class="card ${s2}"><span>${r2}</span><span class="mt-auto self-end">${icons[s2]}</span></div>
            `;
        }

        function checkAction(act) {
            stats.total++;
            const isCorrect = (act === 'raise' && currentHand.r > 0) || 
                              (act === 'call' && currentHand.c > 0) || 
                              (act === 'fold' && (currentHand.r + currentHand.c) < 100);
            
            if(isCorrect) stats.ok++;
            const fb = document.getElementById('feedback');
            fb.innerText = isCorrect ? "ВЕРНО" : "ОШИБКА";
            fb.className = `w-full p-4 rounded-xl text-center font-bold ${isCorrect ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`;
            fb.classList.remove('hidden');
            
            document.getElementById('score').innerText = `${stats.ok}/${stats.total}`;
            setTimeout(nextHand, 800);
        }

        // --- JSON ---
        function exportJSON() {
            const data = JSON.stringify(rangeData);
            const blob = new Blob([data], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'my_range.json';
            a.click();
        }

        function importJSON(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                rangeData = JSON.parse(ev.target.result);
                document.querySelectorAll('.cell').forEach(c => {
                    const d = rangeData[c.dataset.hand];
                    if(d) {
                        c.querySelector('.cell-fill').style.background = `linear-gradient(to top, var(--f-clr) ${100-(d.r+d.c)}%, var(--c-clr) ${100-(d.r+d.c)}% ${100-d.r}%, var(--r-clr) ${100-d.r}% 100%)`;
                    }
                });
            };
            reader.readAsText(e.target.files[0]);
        }

        function clearMatrix() {
            rangeData = {};
            document.querySelectorAll('.cell-fill').forEach(f => f.style.background = '');
        }

        buildMatrix();
        renderSlider();
    </script>
</body>
</html>
