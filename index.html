<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Poker Range Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --base: #11111b; --surf: #1e1e2e; --text: #cdd6f4; --accent: #cba6f7; }
        body { background: var(--base); color: var(--text); font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .matrix { display: grid; grid-template-columns: repeat(13, 1fr); gap: 2px; background: #313244; padding: 5px; border-radius: 6px; }
        .cell { width: 38px; height: 38px; background: #181825; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; position: relative; overflow: hidden; border-radius: 2px; }
        .cell-fill { position: absolute; bottom: 0; left: 0; width: 100%; z-index: 1; transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .cell-text { position: relative; z-index: 2; pointer-events: none; font-weight: 500; }

        .card { width: 90px; height: 126px; border-radius: 12px; display: flex; flex-direction: column; padding: 12px; font-weight: 800; color: white; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .s { background: linear-gradient(135deg, #45475a, #11111b); } /* Пики */
        .h { background: linear-gradient(135deg, #f38ba8, #a61e4d); } /* Черви */
        .c { background: linear-gradient(135deg, #a6e3a1, #2b8a3e); color: #000; } /* Трефы */
        .d { background: linear-gradient(135deg, #89b4fa, #1c7ed6); } /* Бубны */
        .card .val { font-size: 32px; line-height: 1; } .card .suit-icon { font-size: 44px; align-self: flex-end; margin-top: auto; }

        .btn { padding: 12px 24px; border-radius: 8px; font-weight: 700; transition: all 0.2s; text-transform: uppercase; }
        .active-tab { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .hidden { display: none !important; }
        input[type=range] { accent-color: var(--accent); }
    </style>
</head>
<body class="p-6">

    <div class="w-full max-w-4xl flex flex-col items-center gap-6">
        <div class="flex gap-10 text-sm font-bold tracking-widest uppercase">
            <button onclick="setTab('ed')" id="tab-ed" class="pb-2 active-tab transition-all">Редактор</button>
            <button onclick="setTab('tr')" id="tab-tr" class="pb-2 opacity-50 hover:opacity-100">Тренажер</button>
        </div>

        <div class="bg-[#1e1e2e] p-4 rounded-2xl flex gap-4 items-center w-full justify-center shadow-xl border border-white/5">
            <select id="mode" onchange="checkBB()" class="bg-[#313244] p-2 rounded-lg outline-none">
                <option value="RFI">RFI</option>
                <option value="vsOpen">vs Open</option>
                <option value="vs3bet">vs 3-Bet</option>
            </select>
            <select id="hero" onchange="checkBB()" class="bg-[#313244] p-2 rounded-lg outline-none">
                <option>UTG</option><option>MP</option><option>CO</option>
                <option>BTN</option><option>SB</option><option id="hero-bb">BB</option>
            </select>
            <button onclick="loadRemoteChart()" class="bg-indigo-500/20 text-indigo-300 px-4 py-2 rounded-lg border border-indigo-500/30 hover:bg-indigo-500/40 transition-all">Загрузить JSON</button>
        </div>
    </div>

    <div id="view-ed" class="mt-8 flex flex-col items-center gap-6 animate-in fade-in duration-500">
        <div class="flex gap-4 items-center bg-[#1e1e2e] p-4 rounded-xl shadow-inner">
            <div class="flex gap-2">
                <button class="dot w-10 h-10 rounded-lg bg-red-500 border-2 border-transparent" data-a="raise" title="Raise"></button>
                <button class="dot w-10 h-10 rounded-lg bg-green-500 border-2 border-transparent" data-a="call" title="Call"></button>
                <button class="dot w-10 h-10 rounded-lg bg-yellow-500 border-2 border-transparent" data-a="check" title="Check"></button>
                <button class="dot w-10 h-10 rounded-lg bg-blue-500 border-2 border-transparent" data-a="fold" title="Fold"></button>
            </div>
            <div class="h-10 w-[1px] bg-white/10 mx-2"></div>
            <div class="flex flex-col">
                <span class="text-[10px] uppercase opacity-50 mb-1">Вес действия</span>
                <div class="flex items-center gap-3">
                    <input type="range" id="freq-slider" min="5" max="100" step="5" value="100" class="w-32">
                    <span id="freq-val" class="text-sm font-mono w-10">100%</span>
                </div>
            </div>
        </div>

        <div id="matrix" class="matrix"></div>
        
        <div class="flex gap-4">
            <button onclick="exportJSON()" class="text-[11px] uppercase tracking-tighter opacity-40 hover:opacity-100 transition-all">Экспорт файла</button>
            <button onclick="if(confirm('Очистить?')){rangeData={}; renderMatrix()}" class="text-[11px] uppercase tracking-tighter opacity-40 hover:opacity-100 text-red-400">Очистить всё</button>
        </div>
    </div>

    <div id="view-tr" class="hidden mt-12 flex flex-col items-center w-full max-w-md">
        <div id="score" class="mb-6 py-1 px-4 bg-white/5 rounded-full text-xs font-mono opacity-60">СЧЕТ: 0 / 0</div>
        
        <div class="flex gap-6 mb-12" id="cards-spot"></div>

        <div id="feedback" class="h-14 text-center">
            <div id="fb-main" class="text-2xl font-black mb-1"></div>
            <div id="fb-sub" class="text-sm opacity-60 font-medium"></div>
        </div>

        <div class="grid grid-cols-2 gap-4 w-full mt-8">
            <button onclick="handleAct('raise')" class="btn bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500 hover:text-white">Raise</button>
            <button onclick="handleAct('call')" class="btn bg-green-500/10 text-green-400 border border-green-500/20 hover:bg-green-500 hover:text-white">Call</button>
            <button onclick="handleAct('check')" class="btn bg-yellow-500/10 text-yellow-400 border border-yellow-500/20 hover:bg-yellow-500 hover:text-black">Check</button>
            <button onclick="handleAct('fold')" class="btn bg-blue-500/10 text-blue-400 border border-blue-500/20 hover:bg-blue-500 hover:text-white">Fold</button>
        </div>
        
        <button id="next-btn" onclick="deal()" class="mt-10 py-3 px-12 bg-white text-black rounded-full font-bold shadow-lg hidden animate-bounce">СЛЕДУЮЩАЯ</button>
    </div>

<script>
    const RANKS = "AKQJT98765432".split("");
    const SUITS = [
        {id:'s', char:'♠', class:'s'}, {id:'h', char:'♥', class:'h'},
        {id:'c', char:'♣', class:'c'}, {id:'d', char:'♦', class:'d'}
    ];
    const COLORS = { raise:'#f38ba8', call:'#a6e3a1', check:'#f9e2af', fold:'#89b4fa' };
    
    let rangeData = {}; 
    let selAction = 'raise';
    let isDrawing = false;
    let stats = {ok:0, total:0};
    let currentHand = null;

    // Сортировка: Слева всегда старшая карта
    function getCombo(r1, r2, isSuited) {
        let i1 = RANKS.indexOf(r1), i2 = RANKS.indexOf(r2);
        let combo = i1 < i2 ? r1+r2 : r2+r1; 
        if (r1 !== r2) combo += isSuited ? 's' : 'o';
        return combo;
    }

    function checkBB() {
        const m = document.getElementById('mode').value;
        const h = document.getElementById('hero');
        const bb = document.getElementById('hero-bb');
        bb.disabled = (m === 'RFI');
        if (m === 'RFI' && h.value === 'BB') h.value = 'BTN';
    }

    function init() {
        const mx = document.getElementById('matrix');
        RANKS.forEach((r1, i) => {
            RANKS.forEach((r2, j) => {
                const isSuited = i < j;
                const combo = getCombo(r1, r2, isSuited);
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.hand = combo;
                cell.innerHTML = `<div class="cell-fill"></div><div class="cell-text">${combo}</div>`;
                cell.onmousedown = (e) => { e.preventDefault(); isDrawing=true; applyColor(cell); };
                cell.onmouseover = () => { if(isDrawing) applyColor(cell); };
                mx.appendChild(cell);
            });
        });
        window.onmouseup = () => isDrawing = false;

        document.querySelectorAll('.dot').forEach(d => {
            d.onclick = () => {
                document.querySelectorAll('.dot').forEach(x => x.style.borderColor='transparent');
                d.style.borderColor = 'white';
                selAction = d.dataset.a;
            };
        });
        document.querySelector('[data-a="raise"]').click();
        document.getElementById('freq-slider').oninput = (e) => { document.getElementById('freq-val').innerText = e.target.value + '%'; }
    }

    function applyColor(cell) {
        const hand = cell.dataset.hand;
        const freq = parseInt(document.getElementById('freq-slider').value);
        if (selAction === 'fold' && freq === 100) delete rangeData[hand];
        else rangeData[hand] = { a: selAction, f: freq };
        renderMatrix();
    }

    function renderMatrix() {
        document.querySelectorAll('.cell').forEach(cell => {
            const data = rangeData[cell.dataset.hand];
            const fill = cell.querySelector('.cell-fill');
            if (data) {
                fill.style.height = data.f + '%';
                fill.style.background = COLORS[data.a];
            } else { fill.style.height = '0%'; }
        });
    }

    function setTab(t) {
        document.getElementById('view-ed').classList.toggle('hidden', t!=='ed');
        document.getElementById('view-tr').classList.toggle('hidden', t!=='tr');
        document.getElementById('tab-ed').classList.toggle('active-tab', t==='ed');
        document.getElementById('tab-tr').classList.toggle('active-tab', t==='tr');
        document.getElementById('tab-ed').classList.toggle('opacity-50', t!=='ed');
        document.getElementById('tab-tr').classList.toggle('opacity-50', t!=='tr');
        if(t === 'tr') deal();
    }

    function deal() {
        document.getElementById('fb-main').innerText = "";
        document.getElementById('fb-sub').innerText = "";
        document.getElementById('next-btn').classList.add('hidden');
        
        let r1 = RANKS[Math.floor(Math.random()*13)], r2 = RANKS[Math.floor(Math.random()*13)];
        let s1 = SUITS[Math.floor(Math.random()*4)], s2 = SUITS[Math.floor(Math.random()*4)];
        if (r1===r2 && s1.id===s2.id) return deal();

        // Всегда ставим старшую карту ПЕРВОЙ для отображения
        if (RANKS.indexOf(r1) > RANKS.indexOf(r2)) {
            [r1, r2] = [r2, r1]; [s1, s2] = [s2, s1];
        }
        
        currentHand = { r1, r2, s1, s2, combo: getCombo(r1, r2, s1.id===s2.id) };
        
        document.getElementById('cards-spot').innerHTML = `
            <div class="card ${s1.class}"><div class="val">${r1}</div><div class="suit-icon">${s1.char}</div></div>
            <div class="card ${s2.class}"><div class="val">${r2}</div><div class="suit-icon">${s2.char}</div></div>
        `;
    }

    function handleAct(userA) {
        if (!document.getElementById('next-btn').classList.contains('hidden')) return;
        
        const data = rangeData[currentHand.combo] || { a: 'fold', f: 100 };
        const fbMain = document.getElementById('fb-main');
        const fbSub = document.getElementById('fb-sub');
        
        // Логика пограничных рук: не считаем ошибкой, если частота < 100% и выбран Fold или Action
        const isMixed = data.f < 100;
        const isCorrect = (userA === data.a) || (isMixed && userA === 'fold');

        stats.total++;
        if (isCorrect) {
            stats.ok++;
            fbMain.innerText = "ВЕРНО"; fbMain.className = "text-2xl font-black mb-1 text-green-400";
            fbSub.innerText = `${currentHand.combo}: ${data.a.toUpperCase()} (${data.f}%) / FOLD (${100-data.f}%)`;
            setTimeout(deal, 1200);
        } else {
            fbMain.innerText = "ОШИБКА"; fbMain.className = "text-2xl font-black mb-1 text-red-400";
            fbSub.innerText = `Должно быть: ${data.a.toUpperCase()} (${data.f}%)`;
            document.getElementById('next-btn').classList.remove('hidden');
        }
        document.getElementById('score').innerText = `СЧЕТ: ${stats.ok} / ${stats.total}`;
    }

    async function loadRemoteChart() {
        const m = document.getElementById('mode').value;
        const h = document.getElementById('hero').value;
        try {
            const r = await fetch(`charts/${m}_${h}.json`);
            if (!r.ok) throw "404";
            rangeData = await r.json();
            renderMatrix();
            alert("Данные обновлены!");
        } catch(e) { alert("Файл не найден в /charts/"); }
    }

    function exportJSON() {
        const blob = new Blob([JSON.stringify(rangeData, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${document.getElementById('mode').value}_${document.getElementById('hero').value}.json`;
        a.click();
    }

    init();
</script>
</body>
</html>
