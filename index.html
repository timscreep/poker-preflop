<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Elite Poker Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --base: #0d1117; --surf: #161b22; --text: #c9d1d9; --accent: #58a6ff; }
        body { background: var(--base); color: var(--text); font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; }
        
        .poker-table { width: 320px; height: 180px; border: 4px solid #30363d; border-radius: 100px; position: relative; margin: 20px 0; background: radial-gradient(#1f242c, #0b0e14); }
        .pos-node { position: absolute; width: 40px; height: 40px; border-radius: 50%; background: #21262d; border: 2px solid #30363d; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; transition: 0.3s; color: #8b949e; }
        .pos-hero { border-color: #d29922; color: #d29922; box-shadow: 0 0 15px rgba(210,153,34,0.2); transform: scale(1.1); }
        .pos-villain { border-color: #f85149; color: #f85149; box-shadow: 0 0 15px rgba(248,81,73,0.2); }

        .matrix { display: grid; grid-template-columns: repeat(13, 1fr); gap: 1px; background: #30363d; }
        .cell { width: 38px; height: 38px; background: #21262d; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; position: relative; overflow: hidden; }
        .cell-fill-call { position: absolute; bottom: 0; left: 0; width: 100%; background: #a6e3a1; z-index: 1; }
        .cell-fill-raise { position: absolute; top: 0; left: 0; width: 100%; background: #f38ba8; z-index: 1; }
        .cell-text { position: relative; z-index: 10; color: #c9d1d9; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); }

        .card { width: 85px; height: 120px; border-radius: 10px; display: flex; flex-direction: column; padding: 12px; font-weight: 900; color: white; border: 1px solid rgba(255,255,255,0.1); }
        .s { background: #21262d; } .h { background: #da3633; } .c { background: #238636; } .d { background: #1f6feb; }
        .card .val { font-size: 30px; line-height: 1; } .card .suit { font-size: 38px; align-self: flex-end; margin-top: auto; }

        .btn-act { transition: 0.2s; border: 1px solid rgba(255,255,255,0.1); font-weight: 700; padding: 12px; border-radius: 8px; text-transform: uppercase; font-size: 13px; }
        .disabled { opacity: 0.2; pointer-events: none; }
        .active-tab { color: #58a6ff; border-bottom: 2px solid #58a6ff; }
    </style>
</head>
<body class="p-4">

    <div class="flex gap-10 mb-6 font-black uppercase text-[10px] tracking-[0.2em]">
        <button onclick="setTab('ed')" id="tab-ed" class="active-tab pb-1">Editor</button>
        <button onclick="setTab('tr')" id="tab-tr" class="opacity-40 pb-1">Trainer</button>
    </div>

    <div class="bg-[#161b22] p-4 rounded-2xl flex gap-6 mb-8 border border-[#30363d] shadow-2xl">
        <div class="flex flex-col gap-1">
            <label class="text-[10px] uppercase opacity-40 font-bold">Mode</label>
            <select id="mode" onchange="updateUIConfigs()" class="bg-[#0d1117] p-2 rounded border border-gray-700 outline-none text-sm">
                <option value="RFI">RFI</option>
                <option value="vsOpen">vs Open</option>
                <option value="vs3bet">vs 3-Bet</option>
            </select>
        </div>
        <div class="flex flex-col gap-1">
            <label class="text-[10px] uppercase opacity-40 font-bold">Hero</label>
            <select id="hero" onchange="updateUIConfigs()" class="bg-[#0d1117] p-2 rounded border border-gray-700 outline-none text-sm">
                <option>UTG</option><option>MP</option><option>CO</option><option>BTN</option><option>SB</option><option value="BB">BB</option>
            </select>
        </div>
        <div class="flex flex-col gap-1" id="villain-select-container">
            <label class="text-[10px] uppercase opacity-40 font-bold">Villain</label>
            <select id="villain" class="bg-[#0d1117] p-2 rounded border border-gray-700 outline-none text-sm">
                </select>
        </div>
        <button onclick="loadChart()" class="mt-5 px-4 bg-blue-600/10 text-blue-400 border border-blue-600/30 rounded-lg text-xs hover:bg-blue-600/20">Load JSON</button>
    </div>

    <div id="view-ed" class="flex flex-col items-center">
        <div class="flex gap-6 items-center mb-6 bg-[#161b22] p-4 rounded-xl border border-white/5">
            <div class="flex gap-3">
                <button class="dot w-10 h-10 rounded-lg bg-[#f38ba8] border-2 border-transparent" id="btn-raise" data-a="raise"></button>
                <button class="dot w-10 h-10 rounded-lg bg-[#a6e3a1] border-2 border-transparent" id="btn-call" data-a="call"></button>
            </div>
            <div class="flex flex-col gap-1">
                <input type="range" id="freq" min="0" max="100" step="10" value="100" class="w-32 accent-blue-500">
                <div class="flex justify-between text-[10px] font-mono opacity-50"><span>FOLD</span><span id="freq-txt">100% ACT</span></div>
            </div>
            <button onclick="rangeData={}; renderMatrix()" class="text-[10px] text-red-400 uppercase font-bold ml-4 hover:underline">Clear</button>
        </div>
        <div id="matrix" class="matrix shadow-2xl"></div>
    </div>

    <div id="view-tr" class="hidden flex flex-col items-center w-full max-w-sm">
        <div class="poker-table" id="table-visual">
            <div class="pos-node" style="top: -20px; left: 140px;" data-p="UTG">UTG</div>
            <div class="pos-node" style="top: 25px; right: -20px;" data-p="MP">MP</div>
            <div class="pos-node" style="bottom: 25px; right: -20px;" data-p="CO">CO</div>
            <div class="pos-node" style="bottom: -20px; left: 140px;" data-p="BTN">BTN</div>
            <div class="pos-node" style="bottom: 25px; left: -20px;" data-p="SB">SB</div>
            <div class="pos-node" style="top: 25px; left: -20px;" data-p="BB">BB</div>
        </div>

        <div id="cards-spot" class="flex gap-4 mb-8"></div>
        <div id="feedback" class="h-16 text-center text-sm font-medium leading-relaxed"></div>

        <div class="grid grid-cols-2 gap-4 w-full">
            <button onclick="handleAct('raise')" class="btn-act bg-red-500/10 text-red-400 border-red-500/20 hover:bg-red-500 hover:text-white">Raise</button>
            <button id="tr-call" onclick="handleAct('call')" class="btn-act bg-green-500/10 text-green-400 border-green-500/20 hover:bg-green-500 hover:text-white">Call</button>
            <button onclick="handleAct('fold')" class="btn-act bg-blue-500/10 text-blue-400 border-blue-500/20 hover:bg-blue-500 hover:text-white col-span-2">Fold</button>
        </div>
        <button id="next-btn" onclick="deal()" class="mt-8 py-3 px-10 bg-white text-black rounded-full font-black text-xs tracking-widest hidden">NEXT HAND</button>
    </div>

<script>
    const RANKS = "AKQJT98765432".split("");
    const POS = ["UTG", "MP", "CO", "BTN", "SB", "BB"];
    let rangeData = {}; 
    let selAction = 'raise';
    let isDrawing = false;
    let currentHand = null;

    function updateUIConfigs() {
        const mode = document.getElementById('mode').value;
        const hero = document.getElementById('hero');
        const villain = document.getElementById('villain');
        const heroVal = hero.value;

        // 1. Блокировка BB для RFI
        hero.options[5].disabled = (mode === 'RFI');
        if (mode === 'RFI' && heroVal === 'BB') hero.value = 'SB';

        // 2. Настройка доступных действий
        const callBtn = document.getElementById('btn-call');
        if (mode === 'RFI') {
            callBtn.classList.add('disabled');
            if(selAction === 'call') document.getElementById('btn-raise').click();
        } else {
            callBtn.classList.remove('disabled');
        }

        // 3. Список Villain в зависимости от режима
        villain.innerHTML = '';
        const hIdx = POS.indexOf(hero.value);
        if (mode === 'vsOpen') {
            POS.slice(0, hIdx).forEach(p => villain.add(new Option(p, p)));
        } else if (mode === 'vs3bet') {
            POS.slice(hIdx + 1).forEach(p => villain.add(new Option(p, p)));
        }
        document.getElementById('villain-select-container').style.display = (mode==='RFI' ? 'none' : 'flex');
    }

    function init() {
        const mx = document.getElementById('matrix');
        RANKS.forEach((r1, i) => {
            RANKS.forEach((r2, j) => {
                const combo = i < j ? r1+r2+'s' : (i > j ? r2+r1+'o' : r1+r2);
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.hand = combo;
                cell.innerHTML = `<div class="cell-fill-call" style="height:0"></div><div class="cell-fill-raise" style="height:0"></div><div class="cell-text">${combo}</div>`;
                cell.onmousedown = (e) => { e.preventDefault(); isDrawing=true; paint(cell); };
                cell.onmouseover = () => { if(isDrawing) paint(cell); };
                mx.appendChild(cell);
            });
        });
        window.onmouseup = () => isDrawing = false;
        document.querySelectorAll('.dot').forEach(d => d.onclick = () => {
            selAction = d.dataset.a;
            document.querySelectorAll('.dot').forEach(x=>x.style.borderColor='transparent');
            d.style.borderColor = 'white';
        });
        document.getElementById('btn-raise').click();
        document.getElementById('freq').oninput = (e) => document.getElementById('freq-txt').innerText = e.target.value + '% ACT';
        updateUIConfigs();
    }

    function paint(cell) {
        const h = cell.dataset.hand;
        const f = parseInt(document.getElementById('freq').value);
        if (!rangeData[h]) rangeData[h] = { raise: 0, call: 0 };
        
        if (selAction === 'raise') {
            rangeData[h].raise = f;
            if (rangeData[h].raise + rangeData[h].call > 100) rangeData[h].call = 100 - f;
        } else {
            rangeData[h].call = f;
            if (rangeData[h].raise + rangeData[h].call > 100) rangeData[h].raise = 100 - f;
        }
        renderMatrix();
    }

    function renderMatrix() {
        document.querySelectorAll('.cell').forEach(c => {
            const d = rangeData[c.dataset.hand];
            const fCall = c.querySelector('.cell-fill-call');
            const fRaise = c.querySelector('.cell-fill-raise');
            if (d) {
                fCall.style.height = d.call + '%';
                fRaise.style.height = d.raise + '%';
                fRaise.style.top = (100 - d.raise) + '%'; // Рейз сверху
                fCall.style.bottom = '0%'; // Колл снизу
            }
        });
    }

    function setTab(t) {
        document.getElementById('view-ed').classList.toggle('hidden', t!=='ed');
        document.getElementById('view-tr').classList.toggle('hidden', t!=='tr');
        document.getElementById('tab-ed').className = t==='ed' ? 'active-tab pb-1' : 'opacity-40 pb-1';
        document.getElementById('tab-tr').className = t==='tr' ? 'active-tab pb-1' : 'opacity-40 pb-1';
        if(t==='tr') deal();
    }

    function deal() {
        const mode = document.getElementById('mode').value;
        const hPos = document.getElementById('hero').value;
        const vPos = document.getElementById('villain').value;
        
        document.getElementById('feedback').innerText = "";
        document.getElementById('next-btn').classList.add('hidden');
        document.getElementById('tr-call').classList.toggle('disabled', mode === 'RFI');

        document.querySelectorAll('.pos-node').forEach(n => {
            n.className = 'pos-node';
            if (n.dataset.p === hPos) n.classList.add('pos-hero');
            if (mode !== 'RFI' && n.dataset.p === vPos) n.classList.add('pos-villain');
        });

        const r1 = RANKS[Math.floor(Math.random()*13)], r2 = RANKS[Math.floor(Math.random()*13)];
        const s1 = ["s","h","c","d"][Math.floor(Math.random()*4)], s2 = ["s","h","c","d"][Math.floor(Math.random()*4)];
        if (r1===r2 && s1===s2) return deal();
        
        const i1 = RANKS.indexOf(r1), i2 = RANKS.indexOf(r2);
        currentHand = { r1, r2, s1, s2, combo: i1 < i2 ? r1+r2+(s1===s2?'s':'o') : (i1 > i2 ? r2+r1+(s1===s2?'s':'o') : r1+r2) };
        
        // Визуализация старшей карты слева
        let showR1 = r1, showR2 = r2, showS1 = s1, showS2 = s2;
        if (i1 > i2) { [showR1, showR2] = [r2, r1]; [showS1, showS2] = [s2, s1]; }

        const suits = {s:'♠', h:'♥', c:'♣', d:'♦'}, classes = {s:'s', h:'h', c:'c', d:'d'};
        document.getElementById('cards-spot').innerHTML = `
            <div class="card ${classes[showS1]}"><div class="val">${showR1}</div><div class="suit">${suits[showS1]}</div></div>
            <div class="card ${classes[showS2]}"><div class="val">${showR2}</div><div class="suit">${suits[showS2]}</div></div>
        `;
    }

    function handleAct(uA) {
        if (!document.getElementById('next-btn').classList.contains('hidden')) return;
        const d = rangeData[currentHand.combo] || { raise: 0, call: 0 };
        const fb = document.getElementById('feedback');
        
        let correct = false;
        if (uA === 'raise' && d.raise > 0) correct = true;
        else if (uA === 'call' && d.call > 0) correct = true;
        else if (uA === 'fold' && (d.raise + d.call) < 100) correct = true;

        if (correct) {
            fb.innerHTML = `<span class="text-green-400 font-black">GOOD</span><br><span class="text-[11px] opacity-60">RAISE: ${d.raise}% | CALL: ${d.call}% | FOLD: ${100-d.raise-d.call}%</span>`;
            setTimeout(deal, 1200);
        } else {
            fb.innerHTML = `<span class="text-red-500 font-black">MISTAKE</span><br><span class="text-[11px]">Best was: ${d.raise > d.call ? 'RAISE' : (d.call > 0 ? 'CALL' : 'FOLD')}</span>`;
            document.getElementById('next-btn').classList.remove('hidden');
        }
    }

    function loadChart() {
        const path = `charts/${document.getElementById('mode').value}_${document.getElementById('hero').value}.json`;
        fetch(path).then(r => r.json()).then(data => { rangeData = data; renderMatrix(); }).catch(() => alert("File not found"));
    }

    init();
</script>
</body>
</html>
